<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploads</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Uploads</h1>

        <!-- Words Content Section -->
        <div id="words-content-section" class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-xl font-bold mb-2"><i class="fas fa-file-alt"></i> Words Content</h2>
            <div class="mb-2">
                <label class="block text-gray-700">Title</label>
                <select id="words-title" class="w-full p-2 border rounded">
                    <option>Select Title</option>
                </select>
                <button class="mt-2 p-2 bg-blue-500 text-white rounded" data-modal="wordsModal">Add New Title</button>
            </div>
            <div class="mb-2">
                <label class="block text-gray-700">Episode</label>
                <input type="text" class="w-full p-2 border rounded" placeholder="Enter Episode">
            </div>
            <div class="mb-2">
                <label class="block text-gray-700">Content</label>
                <textarea class="w-full p-2 border rounded" placeholder="Enter Content"></textarea>
            </div>
            <button class="mt-2 p-2 bg-green-500 text-white rounded">Upload Words Content</button>
        </div>

        <!-- Audio Content Section -->
        <div id="audio-content-section" class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-xl font-bold mb-2"><i class="fas fa-music"></i> Audio Content</h2>
            <div class="mb-2">
                <label class="block text-gray-700">Title</label>
                <select id="audio-title" class="w-full p-2 border rounded">
                    <option>Select Title</option>
                </select>
                <button class="mt-2 p-2 bg-blue-500 text-white rounded" data-modal="audioModal">Add New Title</button>
            </div>
            <div class="mb-2">
                <label class="block text-gray-700">Episode</label>
                <input type="text" class="w-full p-2 border rounded" placeholder="Enter Episode">
            </div>
            <div class="mb-2">
                <label class="block text-gray-700">Audio Link</label>
                <input type="text" class="w-full p-2 border rounded" placeholder="Enter Audio Link">
            </div>
            <button class="mt-2 p-2 bg-green-500 text-white rounded">Upload Audio Content</button>
        </div>

        <!-- Video Content Section -->
        <div id="video-content-section" class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-xl font-bold mb-2"><i class="fas fa-video"></i> Video Content</h2>
            <div class="mb-2">
                <label class="block text-gray-700">Title</label>
                <select id="video-title" class="w-full p-2 border rounded">
                    <option>Select Title</option>
                </select>
                <button class="mt-2 p-2 bg-blue-500 text-white rounded" data-modal="videoModal">Add New Title</button>
            </div>
            <div class="mb-2">
                <label class="block text-gray-700">Episode</label>
                <input type="text" class="w-full p-2 border rounded" placeholder="Enter Episode">
            </div>
            <div class="mb-2">
                <label class="block text-gray-700">Video Link</label>
                <input type="text" class="w-full p-2 border rounded" placeholder="Enter Video Link">
            </div>
            <button class="mt-2 p-2 bg-green-500 text-white rounded">Upload Video Content</button>
        </div>
    </div>

    <!-- Modal Templates -->
    <div class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center" id="wordsModal">
        <div class="bg-white p-4 rounded shadow-lg w-1/2">
            <h2 class="text-xl font-bold mb-2">Add New Title</h2>
            <input type="text" id="new-words-title" class="w-full p-2 border rounded mb-2" placeholder="Enter New Title">
            <input type="file" id="words-image" class="w-full p-2 border rounded mb-2" accept="image/*">
            <button id="submit-words-title" class="p-2 bg-blue-500 text-white rounded">Submit</button>
            <button class="p-2 bg-red-500 text-white rounded closeModal">Cancel</button>
        </div>
    </div>

    <div class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center" id="audioModal">
        <div class="bg-white p-4 rounded shadow-lg w-1/2">
            <h2 class="text-xl font-bold mb-2">Add New Title</h2>
            <input type="text" id="new-audio-title" class="w-full p-2 border rounded mb-2" placeholder="Enter New Title">
            <input type="file" id="audio-image" class="w-full p-2 border rounded mb-2" accept="image/*">
            <button id="submit-audio-title" class="p-2 bg-blue-500 text-white rounded">Submit</button>
            <button class="p-2 bg-red-500 text-white rounded closeModal">Cancel</button>
        </div>
    </div>

    <div class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center" id="videoModal">
        <div class="bg-white p-4 rounded shadow-lg w-1/2">
            <h2 class="text-xl font-bold mb-2">Add New Title</h2>
            <input type="text" id="new-video-title" class="w-full p-2 border rounded mb-2" placeholder="Enter New Title">
            <input type="file" id="video-image" class="w-full p-2 border rounded mb-2" accept="image/*">
            <button id="submit-video-title" class="p-2 bg-blue-500 text-white rounded">Submit</button>
            <button class="p-2 bg-red-500 text-white rounded closeModal">Cancel</button>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-4 flex justify-around">
        <a href="admin_leo.html" class="flex flex-col items-center">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="upload_leo.html" class="flex flex-col items-center">
            <i class="fas fa-upload"></i>
            <span>Uploads</span>
        </a>
        <a href="#" class="flex flex-col items-center">
            <i class="fas fa-cogs"></i>
            <span>Control</span>
        </a>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const firebaseConfig = {
        apiKey: "AIzaSyDfYDVYx10P9FUUNTlXw3dfTjPNNlR-Rhc",
        authDomain: "simulizi23.firebaseapp.com",
        databaseURL: "https://simulizi23-default-rtdb.firebaseio.com",
        projectId: "simulizi23",
        storageBucket: "simulizi23.firebasestorage.app",
        messagingSenderId: "306995992624",
        appId: "1:306995992624:web:169d1fa3e2866d771e35f5",
        measurementId: "G-7RLGM76PSE"
    };

    const supabaseUrl = "https://ujizsaionvuaimosubii.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqaXpzYWlvbnZ1YWltb3N1YmlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA0ODQ2NjEsImV4cCI6MjA1NjA2MDY2MX0.EYknxThD4-dakvqY91N_HEPWyzQ0izeOeSB9nh6hTUA";
    const bucketName = "Simulizi_app";

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function addNewTitle(type) {
        const titleInput = document.getElementById(`new-${type}-title`).value;
        const fileInput = document.getElementById(`${type}-image`);
        
        if (!titleInput || !fileInput.files[0]) {
            alert('Please enter a title and select an image');
            return;
        }

        const file = fileInput.files[0];
        const fileName = `${Date.now()}_${file.name}`;
        
        const { data, error } = await supabase.storage
            .from(bucketName)
            .upload(`images/${fileName}`, file);

        if (error) {
            alert('Error uploading image: ' + error.message);
            return;
        }

        const { data: urlData } = supabase.storage
            .from(bucketName)
            .getPublicUrl(`images/${fileName}`);

        const imageUrl = urlData.publicUrl;

        const newTitleRef = push(ref(database, 'titles/'));
        await set(newTitleRef, {
            type: `type_${type}`,
            title: titleInput,
            image_url: imageUrl
        });

        alert('Title and image added successfully');
        loadTitles();
        document.getElementById(`${type}Modal`).classList.add('hidden');
    }

    function loadTitles() {
        const wordsTitleSelect = document.getElementById('words-title');
        const audioTitleSelect = document.getElementById('audio-title');
        const videoTitleSelect = document.getElementById('video-title');

        wordsTitleSelect.innerHTML = '<option>Select Title</option>';
        audioTitleSelect.innerHTML = '<option>Select Title</option>';
        videoTitleSelect.innerHTML = '<option>Select Title</option>';

        onValue(ref(database, 'titles/'), (snapshot) => {
            const titles = snapshot.val();
            for (const key in titles) {
                const option = document.createElement('option');
                option.value = titles[key].title;
                option.textContent = titles[key].title;

                switch (titles[key].type) {
                    case 'type_words':
                        wordsTitleSelect.appendChild(option.cloneNode(true));
                        break;
                    case 'type_audio':
                        audioTitleSelect.appendChild(option.cloneNode(true));
                        break;
                    case 'type_video':
                        videoTitleSelect.appendChild(option.cloneNode(true));
                        break;
                }
            }
        });
    }

    // Modal handling
    document.querySelectorAll('[data-modal]').forEach(button => {
        button.addEventListener('click', () => {
            const modal = document.getElementById(button.getAttribute('data-modal'));
            modal.classList.remove('hidden');
        });
    });

    document.querySelectorAll('.closeModal').forEach(button => {
        button.addEventListener('click', () => {
            button.closest('.fixed').classList.add('hidden');
        });
    });

    document.querySelectorAll('.fixed').forEach(modal => {
        modal.addEventListener('click', event => {
            if (event.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });

    document.getElementById('submit-words-title').addEventListener('click', () => addNewTitle('words'));
    document.getElementById('submit-audio-title').addEventListener('click', () => addNewTitle('audio'));
    document.getElementById('submit-video-title').addEventListener('click', () => addNewTitle('video'));

    document.addEventListener('DOMContentLoaded', loadTitles);

async function saveWordsContent() {
    const title = document.getElementById('words-title').value;
    const episode = document.querySelector('#words-content-section input[placeholder="Enter Episode"]').value;
    const content = document.querySelector('#words-content-section textarea').value;

    if (!title || !episode || !content || title === 'Select Title') {
        alert('Please fill in all fields and select a valid title');
        return;
    }

    let imageUrl = '';
    const snapshot = await get(ref(database, 'titles/'));
    const titles = snapshot.val();
    for (const key in titles) {
        if (titles[key].title === title && titles[key].type === 'type_words') {
            imageUrl = titles[key].image_url;
            break;
        }
    }

    if (!imageUrl) {
        alert('No image URL found for the selected title');
        return;
    }

    const wordsRef = push(ref(database, 'words/'));
    await set(wordsRef, {
        title,
        episode,
        status: 0,
        description: content,
        image_url: imageUrl,
        views: 0,
        lock: 0  // Added lock column with default value 0
    });

    alert('Words content uploaded successfully!');
    document.querySelector('#words-content-section').reset();
    location.reload();
}

async function saveAudioContent() {
    const title = document.getElementById('audio-title').value;
    const episode = document.querySelector('#audio-content-section input[placeholder="Enter Episode"]').value;
    const audioUrl = document.querySelector('#audio-content-section input[placeholder="Enter Audio Link"]').value;

    if (!title || !episode || !audioUrl || title === 'Select Title') {
        alert('Please fill in all fields and select a valid title');
        return;
    }

    let imageUrl = '';
    const snapshot = await get(ref(database, 'titles/'));
    const titles = snapshot.val();
    for (const key in titles) {
        if (titles[key].title === title && titles[key].type === 'type_audio') {
            imageUrl = titles[key].image_url;
            break;
        }
    }

    if (!imageUrl) {
        alert('No image URL found for the selected title');
        return;
    }

    const audioRef = push(ref(database, 'audio/'));
    await set(audioRef, {
        title,
        episode,
        status: 0,
        audio_url: audioUrl,
        image_url: imageUrl,
        views: 0,
        lock: 0  // Added lock column with default value 0
    });

    alert('Audio content uploaded successfully!');
    document.querySelector('#audio-content-section').reset();
    location.reload();
}

async function saveVideoContent() {
    const title = document.getElementById('video-title').value;
    const episode = document.querySelector('#video-content-section input[placeholder="Enter Episode"]').value;
    const videoUrl = document.querySelector('#video-content-section input[placeholder="Enter Video Link"]').value;

    if (!title || !episode || !videoUrl || title === 'Select Title') {
        alert('Please fill in all fields and select a valid title');
        return;
    }

    let imageUrl = '';
    const snapshot = await get(ref(database, 'titles/'));
    const titles = snapshot.val();
    for (const key in titles) {
        if (titles[key].title === title && titles[key].type === 'type_video') {
            imageUrl = titles[key].image_url;
            break;
        }
    }

    if (!imageUrl) {
        alert('No image URL found for the selected title');
        return;
    }

    const videoRef = push(ref(database, 'video/'));
    await set(videoRef, {
        title,
        episode,
        status: 0,
        video_url: videoUrl,
        image_url: imageUrl,
        views: 0,
        lock: 0  // Added lock column with default value 0
    });

    alert('Video content uploaded successfully!');
    document.querySelector('#video-content-section').reset();
    location.reload();
}
    document.querySelector('#words-content-section button.mt-2.bg-green-500').addEventListener('click', saveWordsContent);
    document.querySelector('#audio-content-section button.mt-2.bg-green-500').addEventListener('click', saveAudioContent);
    document.querySelector('#video-content-section button.mt-2.bg-green-500').addEventListener('click', saveVideoContent);
</script>
</body>
</html>